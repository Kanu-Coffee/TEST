name: Auto PR Merge

on:
  push:
    branches:
      - codex-dev

jobs:
  auto-pr-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: read
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Detect project language
        id: detect
        shell: bash
        run: |
          if [ -f package.json ]; then
            echo "language=node" >> "$GITHUB_OUTPUT"
          elif [ -f pyproject.toml ] || [ -f requirements.txt ]; then
            echo "language=python" >> "$GITHUB_OUTPUT"
          else
            echo "language=python" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Node.js
        if: steps.detect.outputs.language == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python
        if: steps.detect.outputs.language == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies (Node)
        if: steps.detect.outputs.language == 'node'
        run: |
          npm install

      - name: Run lint/build (Node)
        if: steps.detect.outputs.language == 'node'
        run: |
          set -e
          SCRIPT=$(node - <<'NODE'
          const fs = require('fs');
          if (!fs.existsSync('package.json')) {
            console.log('none');
            process.exit(0);
          }
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const scripts = pkg.scripts || {};
          if (scripts.lint) {
            console.log('lint');
          } else if (scripts.build) {
            console.log('build');
          } else if (scripts.test) {
            console.log('test');
          } else {
            console.log('none');
          }
NODE
          )
          if [ "$SCRIPT" = "none" ]; then
            echo "No npm scripts available for lint/build/test. Skipping."
          else
            npm run "$SCRIPT"
          fi

      - name: Install dependencies (Python)
        if: steps.detect.outputs.language == 'python'
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          elif [ -f pyproject.toml ]; then
            pip install .
          fi

      - name: Run syntax check (Python)
        if: steps.detect.outputs.language == 'python'
        run: |
          python -m compileall .

      - name: Create or update pull request stub
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: codex-dev
          title: "Automated sync from codex-dev"
          body: |
            This pull request is maintained automatically by the auto-pr-merge workflow to keep `codex-dev` changes flowing into `main`.
          delete-branch: false
          draft: false

      - name: Ensure pull request exists
        id: ensure_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const base = 'main';
            const head = `${owner}:codex-dev`;
            const prs = await github.paginate(github.rest.pulls.list, {
              owner,
              repo,
              head,
              base,
              state: 'open'
            });
            let pr = prs[0];
            if (!pr) {
              pr = (await github.rest.pulls.create({
                owner,
                repo,
                head: 'codex-dev',
                base,
                title: 'Automated sync from codex-dev',
                body: 'This PR was created automatically by the auto-pr-merge workflow.'
              })).data;
            } else {
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: pr.number,
                title: 'Automated sync from codex-dev',
                body: 'This PR is automatically updated by the auto-pr-merge workflow.'
              });
            }
            core.setOutput('pr-number', pr.number.toString());

      - name: Approve pull request
        if: steps.ensure_pr.outputs.pr-number != ''
        uses: peter-evans/approve-pull-request@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.ensure_pr.outputs.pr-number }}

      - name: Enable auto-merge
        if: steps.ensure_pr.outputs.pr-number != ''
        uses: peter-evans/enable-pull-request-automerge@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.ensure_pr.outputs.pr-number }}
          merge-method: squash

      - name: Merge pull request
        if: steps.ensure_pr.outputs.pr-number != ''
        uses: peter-evans/merge-pull-request@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.ensure_pr.outputs.pr-number }}
          merge-method: squash
          delete-branch: true
